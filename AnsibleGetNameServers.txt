#!/usr/bin/php
<?php

/* ================================
   CONFIGURATION
================================ */

$API_URL   = "https://127.0.0.1/api/";
$APP_ID    = "AutoScan";
$API_TOKEN = "PUT_YOUR_API_TOKEN_HERE";

$LOG_FILE  = "/var/log/phpipam_nmap_scan.log";

$MARK_OFFLINE = false;   // optional

/* ================================
   INTERNAL FUNCTIONS
================================ */

function logmsg($msg) {
    global $LOG_FILE;
    $line = "[" . date("Y-m-d H:i:s") . "] " . $msg . PHP_EOL;
    file_put_contents($LOG_FILE, $line, FILE_APPEND);
    echo $line;
}

function api_call($endpoint, $method="GET", $data=null) {
    global $API_URL, $APP_ID, $API_TOKEN;

    $ch = curl_init($API_URL . $APP_ID . $endpoint);
    curl_setopt($ch, CURLOPT_HTTPHEADER, [
        "Content-Type: application/json",
        "token: $API_TOKEN"
    ]);
    curl_setopt($ch, CURLOPT_CUSTOMREQUEST, $method);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);

    if ($data !== null)
        curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));

    $result = curl_exec($ch);
    curl_close($ch);

    return json_decode($result, true);
}

function run_nmap($subnet) {
    $cmd = "nmap -sn -n -oX - " . escapeshellarg($subnet);
    return shell_exec($cmd);
}

/* ================================
   MAIN
================================ */

logmsg("=== Nmap AutoScan Started ===");

$subnets = api_call("/subnets/");

if (!$subnets || !isset($subnets['data'])) {
    logmsg("ERROR: Failed to retrieve subnets.");
    exit(1);
}

foreach ($subnets['data'] as $subnet) {

    $id      = $subnet['id'];
    $network = $subnet['subnet'] . "/" . $subnet['mask'];

    // DEFAULT BEHAVIOR:
    // If field missing, assume scan enabled
    $autoScan = isset($subnet['autoScan']) ? (int)$subnet['autoScan'] : 1;

    if ($autoScan === 0) {
        logmsg("Skipping subnet $network (autoScan=0)");
        continue;
    }

    logmsg("Scanning subnet $network");

    $xml = run_nmap($network);

    if (!$xml) {
        logmsg("ERROR: Nmap failed for $network");
        continue;
    }

    $doc = simplexml_load_string($xml);
    if (!$doc) {
        logmsg("ERROR: XML parse failed for $network");
        continue;
    }

    $liveHosts = [];

    foreach ($doc->host as $host) {

        if ((string)$host->status['state'] !== "up")
            continue;

        $ip = "";
        $mac = "";

        foreach ($host->address as $addr) {
            if ((string)$addr['addrtype'] == "ipv4")
                $ip = (string)$addr['addr'];
            if ((string)$addr['addrtype'] == "mac")
                $mac = (string)$addr['addr'];
        }

        if (!$ip)
            continue;

        $liveHosts[] = $ip;

        $existing = api_call("/addresses/search/$ip/");

        if ($existing && isset($existing['data'][0]['id'])) {

            $addrId = $existing['data'][0]['id'];

            api_call("/addresses/$addrId/", "PATCH", [
                "mac"      => $mac,
                "lastSeen" => date("Y-m-d H:i:s"),
                "description" => "Auto-discovered via Nmap"
            ]);

            logmsg("Updated $ip");

        } else {

            api_call("/addresses/", "POST", [
                "ip_addr"  => $ip,
                "subnetId" => $id,
                "mac"      => $mac,
                "hostname" => $ip,
                "description" => "Auto-discovered via Nmap"
            ]);

            logmsg("Inserted $ip");
        }
    }

    if ($MARK_OFFLINE) {
        $existingIPs = api_call("/subnets/$id/addresses/");
        if ($existingIPs && isset($existingIPs['data'])) {
            foreach ($existingIPs['data'] as $addr) {
                if (!in_array($addr['ip'], $liveHosts)) {
                    api_call("/addresses/" . $addr['id'] . "/", "PATCH", [
                        "description" => "Offline"
                    ]);
                }
            }
        }
    }
}

logmsg("=== Scan Complete ===");
