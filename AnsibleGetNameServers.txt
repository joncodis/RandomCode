#!/usr/bin/env python
# -*- coding: utf-8 -*-

"""
Netplan DNS configuration tool for Ubuntu (Python 2.6+ compatible)
"""

import os
import sys
import argparse
import glob
import re
import yaml  # Python's built-in yaml module (pyyaml is typically installed by default on Ubuntu)

def find_netplan_files():
    """Find all netplan yaml files in /etc/netplan/"""
    return glob.glob('/etc/netplan/*.yaml')

def backup_netplan_file(filepath):
    """Create a backup of the netplan file"""
    backup_path = filepath + '.bak'
    with open(filepath, 'r') as src, open(backup_path, 'w') as dst:
        dst.write(src.read())
    return backup_path

def modify_dns_config(filepath, nameservers, apply_changes=False):
    """Modify DNS settings in the netplan file"""
    try:
        with open(filepath, 'r') as f:
            config = yaml.safe_load(f)
        
        modified = False
        
        # Iterate through all network interfaces
        if 'network' in config and 'ethernets' in config['network']:
            for interface in config['network']['ethernets'].values():
                if 'nameservers' in interface and 'addresses' in interface['nameservers']:
                    # Remove existing DNS servers
                    interface['nameservers']['addresses'] = nameservers
                    modified = True
                elif 'dhcp4' in interface and not interface.get('dhcp4', True):
                    # Static IP configuration without DNS specified - add DNS
                    interface['nameservers'] = {'addresses': nameservers}
                    modified = True
        
        if modified:
            backup_path = backup_netplan_file(filepath)
            print("Backup created at: {}".format(backup_path))
            
            with open(filepath, 'w') as f:
                yaml.dump(config, f, default_flow_style=False)
            
            print("DNS servers updated in: {}".format(filepath))
            
            if apply_changes:
                apply_netplan()
        else:
            print("No changes made to: {}".format(filepath))
            return False
        
        return True
    except Exception as e:
        print("Error processing {}: {}".format(filepath, str(e)))
        return False

def apply_netplan():
    """Apply netplan changes"""
    print("Applying netplan changes...")
    os.system('netplan apply')

def main():
    parser = argparse.ArgumentParser(description='Configure DNS nameservers in Ubuntu Netplan')
    parser.add_argument('nameservers', nargs='+', help='DNS nameserver IP addresses')
    parser.add_argument('--apply', action='store_true', help='Apply netplan changes immediately')
    
    args = parser.parse_args()
    
    netplan_files = find_netplan_files()
    if not netplan_files:
        print("No netplan configuration files found in /etc/netplan/")
        sys.exit(1)
    
    print("Found netplan files: {}".format(", ".join(netplan_files)))
    
    any_modified = False
    for filepath in netplan_files:
        if modify_dns_config(filepath, args.nameservers, args.apply):
            any_modified = True
    
    if any_modified and not args.apply:
        print("\nChanges have been made but not applied. Use --apply to activate them.")
    elif not any_modified:
        print("\nNo configuration files were modified.")

if __name__ == '__main__':
    main()
