---
# Playbook to gather hostname and nameserver information - 3
# To change the nameserver delimiter, modify the ns_delimiter variable below
- name: Gather system nameserver information
  hosts: all
  vars:
    # Change this variable to modify the nameserver delimiter
    ns_delimiter: " | "
    error_message: "ERROR: No nameservers found or failed to retrieve"
    output_file: "/tmp/nameserver_report.csv"
  
  tasks:
    - name: Ensure output directory exists
      file:
        path: "/tmp"
        state: directory
      run_once: true
      delegate_to: localhost

    - name: Create CSV header
      copy:
        content: "Ansible Host,System Hostname,Nameservers\n"
        dest: "{{ output_file }}"
      run_once: true
      delegate_to: localhost
      when: not ansible_check_mode

    - name: Gather host facts
      setup:
        gather_subset: '!all'
    
    - name: Get hostname
      command: hostname
      register: hostname_cmd
      changed_when: false
    
    - name: Get nameservers (Ubuntu/Debian - systemd-resolved)
      shell: |
        if systemctl is-active --quiet systemd-resolved; then
          resolvectl status | awk '/DNS Servers:/ {for(i=3; i<=NF; i++) printf "%s ", $i}' | sed 's/ $//'
        else
          grep -E '^nameserver' /etc/resolv.conf | awk '{print $2}'
        fi
      register: ubuntu_nameservers
      ignore_errors: yes
      when: ansible_distribution in ['Ubuntu', 'Debian']
    
    - name: Get nameservers (CentOS/RHEL - NetworkManager)
      shell: |
        if command -v nmcli &> /dev/null && nmcli general status &> /dev/null; then
          nmcli dev show | awk '/IP4.DNS/ {print $2}'
        else
          grep -E '^nameserver' /etc/resolv.conf | awk '{print $2}'
        fi
      register: centos_nameservers
      ignore_errors: yes
      when: ansible_distribution in ['CentOS', 'RedHat']
    
    - name: Get nameservers (fallback method)
      shell: |
        grep -E '^nameserver' /etc/resolv.conf | awk '{print $2}'
      register: fallback_nameservers
      ignore_errors: yes
      when: >
        (ubuntu_nameservers is not defined or ubuntu_nameservers is skipped or ubuntu_nameservers.stdout == '') and
        (centos_nameservers is not defined or centos_nameservers is skipped or centos_nameservers.stdout == '')
    
    - name: Initialize nameservers list
      set_fact:
        nameservers_list: []
    
    - name: Process Ubuntu nameservers
      set_fact:
        nameservers_list: "{{ nameservers_list + ubuntu_nameservers.stdout_lines }}"
      when:
        - ubuntu_nameservers is defined
        - ubuntu_nameservers.stdout is defined
        - ubuntu_nameservers.stdout != ''
    
    - name: Process CentOS nameservers
      set_fact:
        nameservers_list: "{{ nameservers_list + centos_nameservers.stdout_lines }}"
      when:
        - centos_nameservers is defined
        - centos_nameservers.stdout is defined
        - centos_nameservers.stdout != ''
    
    - name: Process fallback nameservers
      set_fact:
        nameservers_list: "{{ nameservers_list + fallback_nameservers.stdout_lines }}"
      when:
        - fallback_nameservers is defined
        - fallback_nameservers.stdout is defined
        - fallback_nameservers.stdout != ''
    
    - name: Format final nameservers output
      set_fact:
        formatted_nameservers: >-
          {{
            (nameservers_list | unique | join(ns_delimiter))
            if nameservers_list | length > 0
            else error_message
          }}
    
    - name: Append results to CSV file
      lineinfile:
        path: "{{ output_file }}"
        line: '"{{ ansible_host }}","{{ hostname_cmd.stdout }}","{{ formatted_nameservers }}"'
        insertafter: EOF
      delegate_to: localhost
      when: not ansible_check_mode
