---
# Playbook to gather hostname and nameserver information - 5
# To change the nameserver delimiter, modify the ns_delimiter variable below
- name: Gather system nameserver information
  hosts: all
  vars:
    # Change this variable to modify the nameserver delimiter
    ns_delimiter: " | "
    error_message: "ERROR: No nameservers found or failed to retrieve"
    output_file: "/tmp/nameserver_report.csv"
  
  tasks:
    - name: Ensure output directory exists
      file:
        path: "/tmp"
        state: directory
      run_once: true
      delegate_to: localhost

    - name: Remove previous report if exists
      file:
        path: "{{ output_file }}"
        state: absent
      run_once: true
      delegate_to: localhost
      when: not ansible_check_mode

    - name: Create fresh CSV header
      copy:
        content: "Ansible Host,System Hostname,Nameservers\n"
        dest: "{{ output_file }}"
      run_once: true
      delegate_to: localhost
      when: not ansible_check_mode

    # [Rest of the playbook remains exactly the same as in previous answer]
    # ... all other tasks unchanged ...
    
    - name: Append results to CSV file
      lineinfile:
        path: "{{ output_file }}"
        line: '"{{ ansible_host }}","{{ hostname_cmd.stdout }}","{{ formatted_nameservers }}"'
        insertafter: EOF
      delegate_to: localhost
      when: not ansible_check_mode
