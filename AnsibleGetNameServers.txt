---
# Ultimate reliable nameserver collection playbook - 10
- name: Gather system nameserver information
  hosts: all
  vars:
    ns_delimiter: " | "
    output_file: "/tmp/nameserver_report.csv"
    local_dns_patterns:
      - '^127\.'
      - '^::1'
      - '^localhost'
      - '^fe80:'
  
  tasks:
    - name: Initialize host reporting
      run_once: true
      delegate_to: localhost
      block:
        - name: Ensure output directory exists
          file:
            path: "/tmp"
            state: directory
        
        - name: Remove previous report if exists
          file:
            path: "{{ output_file }}"
            state: absent
          when: not ansible_check_mode
        
        - name: Create fresh CSV header
          copy:
            content: "Ansible Host,System Hostname,Nameservers\n"
            dest: "{{ output_file }}"
          when: not ansible_check_mode

    - name: Process each host
      block:
        - name: Initialize host report with defaults
          set_fact:
            host_report:
              hostname: "n/a"
              nameservers: "ERROR: Not processed yet"
          tags: always

        - name: Attempt to gather host information
          block:
            - name: Gather minimal host facts
              setup:
                gather_subset: '!all'
              register: host_facts
              ignore_errors: yes
              tags: always
            
            - name: Get hostname (multiple methods)
              block:
                - name: Try hostname command
                  command: hostname
                  register: hostname_cmd
                  changed_when: false
                  ignore_errors: yes
                
                - name: Try hostname file
                  shell: cat /etc/hostname || echo ''
                  register: hostname_file
                  changed_when: false
                  ignore_errors: yes
                
                - name: Set final hostname
                  set_fact:
                    final_hostname: >-
                      {{
                        hostname_cmd.stdout if hostname_cmd is defined and hostname_cmd.stdout | trim != ''
                        else hostname_file.stdout if hostname_file is defined and hostname_file.stdout | trim != ''
                        else 'n/a'
                      }}
              tags: always

            - name: Initialize empty nameserver list
              set_fact:
                nameservers_list: []
              tags: always

            # Ubuntu/Debian collection
            - name: Collect Ubuntu/Debian nameservers
              block:
                - name: Detect DNS system
                  shell: |
                    if [ -f /usr/bin/nmcli ] && systemctl is-active NetworkManager >/dev/null 2>&1; then
                      echo "networkmanager"
                    elif systemctl is-active --quiet systemd-resolved; then
                      echo "systemd-resolved"
                    else
                      echo "resolvconf"
                    fi
                  register: dns_system
                  changed_when: false
                  ignore_errors: yes
                
                - name: Collect from detected system
                  block:
                    - name: NetworkManager collection
                      shell: |
                        nmcli dev show | awk '/IP4.DNS/ {print $2}' | grep -vE '^(127\.|::1|localhost|fe80:)'
                      register: ns_collect
                      changed_when: false
                      ignore_errors: yes
                      when: dns_system.stdout == 'networkmanager'
                    
                    - name: systemd-resolved collection
                      shell: |
                        resolvectl status 2>/dev/null | awk '/DNS Servers:/ {for(i=3; i<=NF; i++) printf "%s ", $i}' | sed 's/ $//' | grep -vE '^(127\.|::1|localhost|fe80:)'
                      register: ns_collect
                      changed_when: false
                      ignore_errors: yes
                      when: dns_system.stdout == 'systemd-resolved'
                    
                    - name: resolv.conf collection
                      shell: |
                        grep -E '^nameserver' /etc/resolv.conf 2>/dev/null | awk '{print $2}' | grep -vE '^(127\.|::1|localhost|fe80:)'
                      register: ns_collect
                      changed_when: false
                      ignore_errors: yes
                      when: dns_system.stdout == 'resolvconf'
                    
                    - name: Add collected nameservers
                      set_fact:
                        nameservers_list: "{{ nameservers_list + (ns_collect.stdout_lines if ns_collect is defined and ns_collect.stdout_lines is defined else []) }}"
                      when: ns_collect is defined
                  ignore_errors: yes
              when: ansible_distribution in ['Ubuntu', 'Debian']
              tags: always

            # CentOS/RHEL collection
            - name: Collect CentOS/RHEL nameservers
              block:
                - name: Try NetworkManager first
                  shell: |
                    nmcli dev show 2>/dev/null | awk '/IP4.DNS/ {print $2}' | grep -vE '^(127\.|::1|localhost|fe80:)'
                  register: ns_collect
                  changed_when: false
                  ignore_errors: yes
                
                - name: Fallback to resolv.conf
                  shell: |
                    grep -E '^nameserver' /etc/resolv.conf 2>/dev/null | awk '{print $2}' | grep -vE '^(127\.|::1|localhost|fe80:)'
                  register: ns_collect
                  changed_when: false
                  ignore_errors: yes
                  when: ns_collect.stdout == '' or ns_collect is not defined
                
                - name: Add collected nameservers
                  set_fact:
                    nameservers_list: "{{ nameservers_list + (ns_collect.stdout_lines if ns_collect is defined and ns_collect.stdout_lines is defined else []) }}"
                  when: ns_collect is defined
              when: ansible_distribution in ['CentOS', 'RedHat']
              tags: always

            # Final processing
            - name: Set final host information
              set_fact:
                host_report:
                  hostname: "{{ final_hostname }}"
                  nameservers: >-
                    {{
                      (nameservers_list | unique | join(ns_delimiter))
                      if nameservers_list is defined and nameservers_list | length > 0
                      else 'ERROR: No remote nameservers found'
                    }}
              tags: always
          
          rescue:
            - name: Set failure information
              set_fact:
                host_report:
                  hostname: "{{ final_hostname | default('n/a') }}"
                  nameservers: "ERROR: Failed to collect nameservers"
              tags: always
          
          always:
            - name: Ensure minimal report exists
              set_fact:
                host_report:
                  hostname: "{{ host_report.hostname | default('n/a') }}"
                  nameservers: "{{ host_report.nameservers | default('ERROR: Unknown collection failure') }}"
              tags: always
        
        - name: Record host information
          lineinfile:
            path: "{{ output_file }}"
            line: '"{{ ansible_host }}","{{ host_report.hostname }}","{{ host_report.nameservers }}"'
            insertafter: EOF
          delegate_to: localhost
          when: not ansible_check_mode
          tags: always
      tags: always
