import json
import requests
import urllib3
urllib3.disable_warnings()
    
# Generate Bearer Token
def generate_bearer_token(vraUrl,vraRefreshToken):
    print('Generating Bearer Token...')    
    body = {
        "refreshToken": vraRefreshToken
    }
    print(body)
    response_bearerToken = requests.post('https://' + vraUrl + '/iaas/api/login', data=json.dumps(body), verify=False)
    if response_bearerToken.status_code == 200:
        vraBearerToken = response_bearerToken.json()['token']
        print("VRA Bearer Token: "+ vraBearerToken)
    else:
        print('[?] Unexpected Error: [HTTP {0}]: Content: {1}'.format(response_bearerToken.status_code, response_bearerToken.content))
        
    return vraBearerToken
    
# Discovering Subscriber Email
def getemail(vracps, userName, vraBearerToken, orgId):
    print('Discovering Subscriber Email...')
    headers = {"Accept":"application/json","Content-Type":"application/json", "csp-auth-token":vraBearerToken }
    response_Email = requests.get('https://' + vracps + '/csp/gateway/am/api/users/' + userName + '/orgs/' + orgId + '/info', data='', headers=headers, verify=False)
    if response_Email.status_code == 200:
        myEmail = response_Email.json()['user']['email']
    else:
        print('[?] Unexpected Error: [HTTP {0}]: Content: {1}'.format(response_Email.status_code, response_Email.content)) 
    
    return myEmail

def handler(context, inputs):
    
    userName = format(inputs["userName"])
    orgId = format(inputs["orgId"])
    
    print('Requested By ' + userName)
    print('Long organisation Id' + orgId)
    
    ######## vRA Configuration START #####################
    
    vraUrl = 'api.mgmt.cloud.vmware.com' # vRA Cloud URL
    vraCloud = 'on' # “on” for using vRAC Cloud | “off” for using vRA 8.1 on-prem
    if vraCloud == "on":
        vraUrl = 'api.mgmt.cloud.vmware.com'
        vracps = 'console.cloud.vmware.com'
    else:
        vracps = vraUrl
    vraRefreshToken = 'xxxxxxxxxxxxx' ## UPDATE YOUR VRA API (REFRESH) TOKEN

    ######## VARIABLE ENDS #####################
   
    vraBearerToken = generate_bearer_token(vraUrl,vraRefreshToken)
    email = getemail(vracps, userName, vraBearerToken, orgId)
    outputs = {
      "Email Address": email
    }
    
    return outputs
   
