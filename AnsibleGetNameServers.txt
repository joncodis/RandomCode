from datetime import datetime


def handler(context, inputs):

    props = inputs.get("customProperties", {}).copy()

    # --- Existing enrichment (example) ---
    username = inputs.get("requestedBy")
    props["builderEmail"] = lookup_email(username)
    props["builderFullName"] = lookup_fullname(username)

    # --- VM identity ---
    resource_names = inputs.get("resourceNames", [])
    addresses = inputs.get("addresses", [])
    macs = inputs.get("macAddresses", [])

    hostname = resource_names[0] if resource_names else None
    ip = addresses[0] if addresses else None
    mac = macs[0] if macs else None

    # --- Build vmInfo structure ---
    props["vmInfo"] = {

        # Identity
        "hostname": hostname,
        "ipAddress": ip,
        "macAddress": mac,
        "deploymentId": inputs.get("deploymentId"),

        # Request context
        "requestedBy": username,
        "builderEmail": props.get("builderEmail"),
        "builderName": props.get("builderFullName"),

        # Platform context
        "project": inputs.get("projectName"),
        "deploymentName": inputs.get("deploymentName"),

        # Lifecycle metadata
        "provisionedAtUTC": datetime.utcnow().isoformat()
    }

    return {"customProperties": props}



vm = props.get("vmInfo", {})

body = f"""
Your VM is ready.

Hostname: {vm.get('hostname')}
IP Address: {vm.get('ipAddress')}
Requested By: {vm.get('requestedBy')}

Builder Contact:
{vm.get('builderName')} ({vm.get('builderEmail')})

Deployment ID:
{vm.get('deploymentId')}
"""
