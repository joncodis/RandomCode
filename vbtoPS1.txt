package main

import (
	"context"
	"flag"
	"fmt"
	"net/url"
	"os"

	"github.com/vmware/govmomi"
	"github.com/vmware/govmomi/find"
	"github.com/vmware/govmomi/view"
	"github.com/vmware/govmomi/vim25/mo"
)

func main() {
	// Command-line flags
	vcenterURL := flag.String("url", "", "vCenter SDK URL (e.g. https://user:pass@host/sdk)")
	insecure := flag.Bool("insecure", true, "Skip TLS verification")
	flag.Parse()

	if *vcenterURL == "" {
		fmt.Fprintln(os.Stderr, "Missing required -url flag")
		os.Exit(1)
	}

	// Parse URL
	u, err := url.Parse(*vcenterURL)
	if err != nil {
		fmt.Fprintf(os.Stderr, "Error parsing URL: %v\n", err)
		os.Exit(1)
	}

	ctx := context.Background()

	// Create vSphere client
	client, err := govmomi.NewClient(ctx, u, *insecure)
	if err != nil {
		fmt.Fprintf(os.Stderr, "Error connecting to vCenter: %v\n", err)
		os.Exit(1)
	}
	defer client.Logout(ctx)

	// Create a view manager
	mgr := view.NewManager(client.Client)

	// Create a container view of VirtualMachine objects
	view, err := mgr.CreateContainerView(ctx, client.ServiceContent.RootFolder, []string{"VirtualMachine"}, true)
	if err != nil {
		fmt.Fprintf(os.Stderr, "Error creating container view: %v\n", err)
		os.Exit(1)
	}
	defer view.Destroy(ctx)

	// Get VM list
	var vms []mo.VirtualMachine
	err = view.Retrieve(ctx, []string{"VirtualMachine"}, []string{"name"}, &vms)
	if err != nil {
		fmt.Fprintf(os.Stderr, "Error retrieving VMs: %v\n", err)
		os.Exit(1)
	}

	fmt.Printf("Found %d VMs:\n", len(vms))
	for _, vm := range vms {
		fmt.Println("- " + vm.Name)
	}
}
