---
- name: Gather DNS configuration from Ubuntu hosts
  hosts: all
  gather_facts: true
  become: false

  tasks:
    - name: Check if host is Ubuntu
      ansible.builtin.fail:
        msg: "This playbook only runs on Ubuntu systems"
      when: ansible_distribution != 'Ubuntu'
      run_once: true

    - name: Gather DNS configuration from systemd-resolved
      ansible.builtin.command: systemd-resolve --status
      register: dns_systemd_resolved
      when: ansible_distribution == 'Ubuntu' and ansible_distribution_version >= '20.04'
      ignore_errors: yes

    - name: Gather DNS configuration from resolv.conf
      ansible.builtin.shell: cat /etc/resolv.conf
      register: dns_resolv_conf
      when: ansible_distribution == 'Ubuntu'

    - name: Gather DNS configuration from netplan (if exists)
      ansible.builtin.shell: |
        find /etc/netplan -name "*.yaml" -exec cat {} \;
      register: dns_netplan
      when: ansible_distribution == 'Ubuntu'
      ignore_errors: yes

    - name: Display gathered DNS information
      ansible.builtin.debug:
        msg: |
          === DNS Configuration for {{ ansible_hostname }} ===
          == Systemd-resolved ==
          {{ dns_systemd_resolved.stdout | default('Not available') }}

          == resolv.conf ==
          {{ dns_resolv_conf.stdout | default('Not available') }}

          == Netplan config ==
          {{ dns_netplan.stdout | default('Not available') }}
